
<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>docs: Go Coverage Report</title>
		<style>
			body {
				background: black;
				color: rgb(80, 80, 80);
			}
			body, pre, #legend span {
				font-family: Menlo, monospace;
				font-weight: bold;
			}
			#topbar {
				background: black;
				position: fixed;
				top: 0; left: 0; right: 0;
				height: 42px;
				border-bottom: 1px solid rgb(80, 80, 80);
			}
			#content {
				margin-top: 50px;
			}
			#nav, #legend {
				float: left;
				margin-left: 10px;
			}
			#legend {
				margin-top: 12px;
			}
			#nav {
				margin-top: 10px;
			}
			#legend span {
				margin: 0 5px;
			}
			.cov0 { color: rgb(192, 0, 0) }
.cov1 { color: rgb(128, 128, 128) }
.cov2 { color: rgb(116, 140, 131) }
.cov3 { color: rgb(104, 152, 134) }
.cov4 { color: rgb(92, 164, 137) }
.cov5 { color: rgb(80, 176, 140) }
.cov6 { color: rgb(68, 188, 143) }
.cov7 { color: rgb(56, 200, 146) }
.cov8 { color: rgb(44, 212, 149) }
.cov9 { color: rgb(32, 224, 152) }
.cov10 { color: rgb(20, 236, 155) }

		</style>
	</head>
	<body>
		<div id="topbar">
			<div id="nav">
				<select id="files">
				
				<option value="file0">github.com/majikana-rinadehi/backend-manage-stock-go/docs/docs.go (100.0%)</option>
				
				<option value="file1">github.com/majikana-rinadehi/backend-manage-stock-go/internal/repositories/stock_category_repository.go (0.0%)</option>
				
				<option value="file2">github.com/majikana-rinadehi/backend-manage-stock-go/internal/repositories/stock_repository.go (37.5%)</option>
				
				<option value="file3">github.com/majikana-rinadehi/backend-manage-stock-go/internal/repositories/user_repository.go (0.0%)</option>
				
				<option value="file4">github.com/majikana-rinadehi/backend-manage-stock-go/main.go (0.0%)</option>
				
				<option value="file5">github.com/majikana-rinadehi/backend-manage-stock-go/pkg/adapters/database.go (73.0%)</option>
				
				<option value="file6">github.com/majikana-rinadehi/backend-manage-stock-go/pkg/adapters/handlers/stock_category_handler.go (0.0%)</option>
				
				<option value="file7">github.com/majikana-rinadehi/backend-manage-stock-go/pkg/adapters/handlers/stock_handler.go (65.1%)</option>
				
				<option value="file8">github.com/majikana-rinadehi/backend-manage-stock-go/pkg/adapters/handlers/user_handler.go (0.0%)</option>
				
				<option value="file9">github.com/majikana-rinadehi/backend-manage-stock-go/pkg/adapters/http.go (0.0%)</option>
				
				<option value="file10">github.com/majikana-rinadehi/backend-manage-stock-go/pkg/entities/stock.go (100.0%)</option>
				
				<option value="file11">github.com/majikana-rinadehi/backend-manage-stock-go/pkg/interfaces/handlers/error_struct.go (90.9%)</option>
				
				<option value="file12">github.com/majikana-rinadehi/backend-manage-stock-go/pkg/interfaces/handlers/response_struct.go (100.0%)</option>
				
				<option value="file13">github.com/majikana-rinadehi/backend-manage-stock-go/pkg/usecases/stock_category_uc.go (0.0%)</option>
				
				<option value="file14">github.com/majikana-rinadehi/backend-manage-stock-go/pkg/usecases/stock_uc.go (0.0%)</option>
				
				<option value="file15">github.com/majikana-rinadehi/backend-manage-stock-go/pkg/usecases/user_uc.go (0.0%)</option>
				
				<option value="file16">github.com/majikana-rinadehi/backend-manage-stock-go/util/customStringer.go (100.0%)</option>
				
				<option value="file17">github.com/majikana-rinadehi/backend-manage-stock-go/util/testUtil/testUtil.go (83.3%)</option>
				
				<option value="file18">github.com/majikana-rinadehi/backend-manage-stock-go/util/validator.go (92.0%)</option>
				
				</select>
			</div>
			<div id="legend">
				<span>not tracked</span>
			
				<span class="cov0">not covered</span>
				<span class="cov8">covered</span>
			
			</div>
		</div>
		<div id="content">
		
		<pre class="file" id="file0" style="display: none">// Package docs GENERATED BY SWAG; DO NOT EDIT
// This file was generated by swaggo/swag
package docs

import "github.com/swaggo/swag"

const docTemplate = `{
    "schemes": {{ marshal .Schemes }},
    "swagger": "2.0",
    "info": {
        "description": "{{escape .Description}}",
        "title": "{{.Title}}",
        "contact": {},
        "version": "{{.Version}}"
    },
    "host": "{{.Host}}",
    "basePath": "{{.BasePath}}",
    "paths": {
        "/categories": {
            "get": {
                "produces": [
                    "application/json"
                ],
                "tags": [
                    "Category"
                ],
                "summary": "Categoryを全件取得",
                "responses": {
                    "200": {
                        "description": "OK",
                        "schema": {
                            "type": "array",
                            "items": {
                                "$ref": "#/definitions/entities.StockCategory"
                            }
                        }
                    },
                    "400": {
                        "description": "Bad Request"
                    },
                    "500": {
                        "description": "Internal Server Error"
                    }
                }
            }
        },
        "/stocks": {
            "get": {
                "produces": [
                    "application/json"
                ],
                "tags": [
                    "Stock"
                ],
                "summary": "Stockを全件取得",
                "responses": {
                    "200": {
                        "description": "OK",
                        "schema": {
                            "type": "array",
                            "items": {
                                "$ref": "#/definitions/entities.Stock"
                            }
                        }
                    },
                    "400": {
                        "description": "Bad Request"
                    },
                    "500": {
                        "description": "Internal Server Error"
                    }
                }
            },
            "post": {
                "produces": [
                    "application/json"
                ],
                "tags": [
                    "Stock"
                ],
                "summary": "Stockを1件登録",
                "parameters": [
                    {
                        "description": "Stock",
                        "name": "body",
                        "in": "body",
                        "schema": {
                            "$ref": "#/definitions/entities.Stock"
                        }
                    }
                ],
                "responses": {
                    "200": {
                        "description": "登録したStock",
                        "schema": {
                            "$ref": "#/definitions/entities.Stock"
                        }
                    },
                    "400": {
                        "description": "Bad Request"
                    },
                    "500": {
                        "description": "Internal Server Error"
                    }
                }
            }
        },
        "/stocks/{id}": {
            "put": {
                "produces": [
                    "application/json"
                ],
                "tags": [
                    "Stock"
                ],
                "summary": "idで指定したStockを1件更新する",
                "parameters": [
                    {
                        "type": "string",
                        "description": "ID",
                        "name": "id",
                        "in": "path"
                    },
                    {
                        "description": "Stock",
                        "name": "body",
                        "in": "body",
                        "schema": {
                            "$ref": "#/definitions/entities.Stock"
                        }
                    }
                ],
                "responses": {
                    "200": {
                        "description": "OK"
                    },
                    "400": {
                        "description": "Bad Request"
                    },
                    "500": {
                        "description": "Internal Server Error"
                    }
                }
            },
            "delete": {
                "produces": [
                    "application/json"
                ],
                "tags": [
                    "Stock"
                ],
                "summary": "idで指定したStockを1件削除する",
                "parameters": [
                    {
                        "type": "string",
                        "description": "ID",
                        "name": "id",
                        "in": "path"
                    }
                ],
                "responses": {
                    "204": {
                        "description": "No Content"
                    },
                    "400": {
                        "description": "Bad Request"
                    },
                    "500": {
                        "description": "Internal Server Error"
                    }
                }
            }
        },
        "/users": {
            "get": {
                "produces": [
                    "application/json"
                ],
                "tags": [
                    "User"
                ],
                "summary": "Userを全件取得",
                "responses": {
                    "200": {
                        "description": "OK",
                        "schema": {
                            "type": "array",
                            "items": {
                                "$ref": "#/definitions/entities.User"
                            }
                        }
                    },
                    "400": {
                        "description": "Bad Request"
                    },
                    "500": {
                        "description": "Internal Server Error"
                    }
                }
            }
        }
    },
    "definitions": {
        "entities.Stock": {
            "type": "object",
            "properties": {
                "amount": {
                    "type": "integer"
                },
                "categoryId": {
                    "type": "integer"
                },
                "expireDate": {
                    "type": "string"
                },
                "id": {
                    "type": "integer"
                },
                "name": {
                    "type": "string"
                },
                "userId": {
                    "type": "integer"
                }
            }
        },
        "entities.StockCategory": {
            "type": "object",
            "properties": {
                "id": {
                    "type": "integer"
                },
                "name": {
                    "type": "string"
                },
                "userId": {
                    "type": "integer"
                }
            }
        },
        "entities.User": {
            "type": "object",
            "properties": {
                "id": {
                    "type": "integer"
                },
                "mailAddress": {
                    "type": "string"
                },
                "name": {
                    "type": "string"
                }
            }
        }
    }
}`

// SwaggerInfo holds exported Swagger Info so clients can modify it
var SwaggerInfo = &amp;swag.Spec{
        Version:          "",
        Host:             "",
        BasePath:         "",
        Schemes:          []string{},
        Title:            "",
        Description:      "",
        InfoInstanceName: "swagger",
        SwaggerTemplate:  docTemplate,
}

func init() <span class="cov8" title="1">{
        swag.Register(SwaggerInfo.InstanceName(), SwaggerInfo)
}</span>
</pre>
		
		<pre class="file" id="file1" style="display: none">package repositories

import (
        "github.com/majikana-rinadehi/backend-manage-stock-go/pkg/adapters"
        "github.com/majikana-rinadehi/backend-manage-stock-go/pkg/entities"
        "github.com/majikana-rinadehi/backend-manage-stock-go/pkg/interfaces"
)

type StockCategoryRepository struct {
        dbAdapter *adapters.DatabaseAdapter
}

func NewStockCategoryRepository(a *adapters.DatabaseAdapter) interfaces.StockCategoryRepository <span class="cov0" title="0">{
        return &amp;StockCategoryRepository{
                dbAdapter: a,
        }
}</span>

func (r *StockCategoryRepository) FindAll() (stockCategories []*entities.StockCategory, err error) <span class="cov0" title="0">{
        db, dbErr := r.dbAdapter.GetDB()
        if dbErr != nil </span><span class="cov0" title="0">{
                return nil, dbErr
        }</span>

        <span class="cov0" title="0">if err := db.Find(&amp;stockCategories).Error; err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov0" title="0">return stockCategories, nil</span>
}

func (r *StockCategoryRepository) Save(stockCategory *entities.StockCategory) (*entities.StockCategory, error) <span class="cov0" title="0">{
        db, dbErr := r.dbAdapter.GetDB()
        if dbErr != nil </span><span class="cov0" title="0">{
                return nil, dbErr
        }</span>

        <span class="cov0" title="0">if err := db.Create(&amp;stockCategory).Error; err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov0" title="0">return stockCategory, nil</span>
}
</pre>
		
		<pre class="file" id="file2" style="display: none">package repositories

import (
        "github.com/majikana-rinadehi/backend-manage-stock-go/pkg/adapters"
        "github.com/majikana-rinadehi/backend-manage-stock-go/pkg/entities"
        "github.com/majikana-rinadehi/backend-manage-stock-go/pkg/interfaces"
        "gorm.io/gorm/clause"
)

type StockRepository struct {
        dbAdapter *adapters.DatabaseAdapter
}

func NewStockRepository(a *adapters.DatabaseAdapter) interfaces.StockRepository <span class="cov0" title="0">{
        return &amp;StockRepository{
                dbAdapter: a,
        }
}</span>

func (r *StockRepository) FindAll() (stocks []*entities.Stock, err error) <span class="cov8" title="1">{
        db, dbErr := r.dbAdapter.GetDB()
        if dbErr != nil </span><span class="cov0" title="0">{
                return nil, dbErr
        }</span>

        <span class="cov8" title="1">if err := db.Find(&amp;stocks).Error; err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov8" title="1">return stocks, nil</span>
}

func (r *StockRepository) Save(stock *entities.Stock) (*entities.Stock, error) <span class="cov8" title="1">{
        db, dbErr := r.dbAdapter.GetDB()
        if dbErr != nil </span><span class="cov0" title="0">{
                return nil, dbErr
        }</span>

        <span class="cov8" title="1">if err := db.Create(&amp;stock).Error; err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov8" title="1">return stock, nil</span>
}

func (r *StockRepository) DeleteById(id int) error <span class="cov8" title="1">{
        db, dbErr := r.dbAdapter.GetDB()
        if dbErr != nil </span><span class="cov0" title="0">{
                return dbErr
        }</span>

        <span class="cov8" title="1">if err := db.
                Clauses(clause.Returning{}).
                Where("id = ?", id).
                Delete(&amp;entities.Stock{}).Error; err != nil </span><span class="cov0" title="0">{
                return err
        }</span>

        <span class="cov8" title="1">return nil</span>
}

func (r *StockRepository) Update(id int, stock *entities.Stock) (*entities.Stock, error) <span class="cov0" title="0">{
        db, dbErr := r.dbAdapter.GetDB()
        if dbErr != nil </span><span class="cov0" title="0">{
                return nil, dbErr
        }</span>

        <span class="cov0" title="0">if err := db.
                Model(&amp;entities.Stock{}).
                Where("id = ?", id).
                Updates(map[string]any{
                        "category_id": stock.CategoryId,
                        "name":        stock.Name,
                        "amount":      stock.Amount,
                        "expire_date": stock.ExpireDate,
                }).Error; err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov0" title="0">return stock, nil</span>
}

func (r *StockRepository) CountById(id int) (int64, error) <span class="cov0" title="0">{
        db, dbErr := r.dbAdapter.GetDB()
        if dbErr != nil </span><span class="cov0" title="0">{
                return 0, dbErr
        }</span>

        <span class="cov0" title="0">var count int64

        if err := db.
                Model(&amp;entities.Stock{}).
                Where("id = ?", id).
                Count(&amp;count).Error; err != nil </span><span class="cov0" title="0">{
                return 0, err
        }</span>

        <span class="cov0" title="0">return count, nil</span>
}
</pre>
		
		<pre class="file" id="file3" style="display: none">package repositories

import (
        "github.com/majikana-rinadehi/backend-manage-stock-go/pkg/adapters"
        "github.com/majikana-rinadehi/backend-manage-stock-go/pkg/entities"
        "github.com/majikana-rinadehi/backend-manage-stock-go/pkg/interfaces"
)

type UserRepository struct {
        dbAdapter *adapters.DatabaseAdapter
}

func NewUserRepository(a *adapters.DatabaseAdapter) interfaces.UserRepository <span class="cov0" title="0">{
        return &amp;UserRepository{
                dbAdapter: a,
        }
}</span>

func (r *UserRepository) FindAll() (stocks []*entities.User, err error) <span class="cov0" title="0">{
        db, dbErr := r.dbAdapter.GetDB()
        if dbErr != nil </span><span class="cov0" title="0">{
                return nil, dbErr
        }</span>

        <span class="cov0" title="0">if err := db.Find(&amp;stocks).Error; err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov0" title="0">return stocks, nil</span>
}

func (r *UserRepository) Save(stock *entities.User) (*entities.User, error) <span class="cov0" title="0">{
        db, dbErr := r.dbAdapter.GetDB()
        if dbErr != nil </span><span class="cov0" title="0">{
                return nil, dbErr
        }</span>

        <span class="cov0" title="0">if err := db.Create(&amp;stock).Error; err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov0" title="0">return stock, nil</span>
}
</pre>
		
		<pre class="file" id="file4" style="display: none">// アプリケーションのエントリポイントとなります
package main

import (
        "log"

        "github.com/gin-contrib/cors"
        "github.com/gin-gonic/gin"
        _ "github.com/majikana-rinadehi/backend-manage-stock-go/docs"
        "github.com/majikana-rinadehi/backend-manage-stock-go/internal/repositories"
        "github.com/majikana-rinadehi/backend-manage-stock-go/pkg/adapters"
        "github.com/majikana-rinadehi/backend-manage-stock-go/pkg/usecases"
        swaggerFiles "github.com/swaggo/files"
        ginSwagger "github.com/swaggo/gin-swagger"
)

func main() <span class="cov0" title="0">{
        // アダプターの取得、DB接続処理
        a := adapters.NewDatabaseAdapter()
        connErr := a.Connect(false)
        if connErr != nil </span><span class="cov0" title="0">{
                log.Fatal()
        }</span>

        // リポジトリのセットアップ
        <span class="cov0" title="0">stockRepository := repositories.NewStockRepository(a)
        stockCategoryRepository := repositories.NewStockCategoryRepository(a)
        userRepository := repositories.NewUserRepository(a)

        // ユースケースのセットアップ
        stockUsecase := usecases.NewStockUsecase(stockRepository)
        stockCategoryUsecase := usecases.NewStockCategoryUsecase(stockCategoryRepository)
        userUsecase := usecases.NewUserUsecase(userRepository)

        // HTTPアダプターの作成
        httpAdapter := adapters.NewHTTPAdapter(stockUsecase, stockCategoryUsecase, userUsecase)

        router := gin.Default()
        // CORS設定
        config := cors.DefaultConfig()
        config.AllowOrigins = []string{"http://localhost:5173", "http://127.0.0.1:5173"}
        config.AllowMethods = []string{"GET", "POST", "PUT", "DELETE"}
        router.Use(cors.New(config))

        // ルーティングのセットアップ
        httpAdapter.SetupRoutes(router)

        // http://localhost:8080/swagger/index.html にswagger UI を表示する
        router.GET("/swagger/*any", ginSwagger.WrapHandler(swaggerFiles.Handler))

        // サーバの起動
        log.Fatal(router.Run())</span>
}
</pre>
		
		<pre class="file" id="file5" style="display: none">package adapters

import (
        "fmt"
        "os"

        "github.com/joho/godotenv"
        "github.com/majikana-rinadehi/backend-manage-stock-go/pkg/interfaces"
        "gorm.io/driver/mysql"
        "gorm.io/gorm"
)

type DatabaseAdapter struct {
        interfaces.Database
        db *gorm.DB
}

func NewDatabaseAdapter() *DatabaseAdapter <span class="cov8" title="1">{
        return &amp;DatabaseAdapter{}
}</span>

func (a *DatabaseAdapter) Connect(isTest bool) error <span class="cov8" title="1">{
        // データベースに接続する処理
        dsn := a.GetDSN(isTest)
        db, err := gorm.Open(mysql.Open(dsn), &amp;gorm.Config{})
        if err != nil </span><span class="cov0" title="0">{
                return err
        }</span>
        <span class="cov8" title="1">a.db = db
        return nil</span>
}

func (a *DatabaseAdapter) Disconnect() error <span class="cov0" title="0">{
        // データベースから切断する処理
        db, err := a.GetDB()
        if err != nil </span><span class="cov0" title="0">{
                return err
        }</span>
        <span class="cov0" title="0">sqlDB, _ := db.DB()
        return sqlDB.Close()</span>
}

func (a *DatabaseAdapter) GetDB() (*gorm.DB, error) <span class="cov8" title="1">{
        // GORMのDBインスタンスを返す処理
        if a.db == nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("database connection not established")
        }</span>
        <span class="cov8" title="1">return a.db, nil</span>
}

func (a *DatabaseAdapter) GetDSN(isTest bool) string <span class="cov8" title="1">{
        env := os.Getenv("MANAGE_STOCK_ENV")

        switch env </span>{
        case "production":<span class="cov0" title="0">
                env = "production"</span>
        default:<span class="cov8" title="1">
                env = "development"</span>
        }

        <span class="cov8" title="1">if isTest </span><span class="cov8" title="1">{
                os.Setenv("DBUSER", "root")
                os.Setenv("DBPASS", "root")
                // ↓↓↓ここはテスト用(DB名に「test」を含むこと)にしないと、
                // panic: testfixtures: database "manage_stock" does not appear to be a test database
                os.Setenv("DBNAME", "manage_stock_test")
                os.Setenv("DBHOST", "localhost")
                os.Setenv("DBPORT_TEST", "3307")
        }</span> else<span class="cov0" title="0"> {
                godotenv.Load(".env." + env)
        }</span>

        <span class="cov8" title="1">DBUSER := os.Getenv("DBUSER")
        DBPASS := os.Getenv("DBPASS")
        DBNAME := os.Getenv("DBNAME")
        DBHOST := os.Getenv("DBHOST")
        var DBPORT string
        if isTest </span><span class="cov8" title="1">{
                DBPORT = os.Getenv("DBPORT_TEST")
        }</span> else<span class="cov0" title="0"> {
                DBPORT = os.Getenv("DBPORT")

        }</span>

        <span class="cov8" title="1">CONNECT := DBUSER + ":" + DBPASS + "@tcp(" + DBHOST + ":" + DBPORT + ")/" + DBNAME + "?charset=utf8mb4&amp;parseTime=True&amp;loc=Local&amp;multiStatements=true"
        fmt.Println(CONNECT)

        return CONNECT</span>
}
</pre>
		
		<pre class="file" id="file6" style="display: none">package handlers

import (
        "fmt"
        "net/http"

        "github.com/gin-gonic/gin"

        _ "github.com/majikana-rinadehi/backend-manage-stock-go/docs"
        "github.com/majikana-rinadehi/backend-manage-stock-go/pkg/entities"
        "github.com/majikana-rinadehi/backend-manage-stock-go/pkg/interfaces/handlers"
        "github.com/majikana-rinadehi/backend-manage-stock-go/pkg/interfaces/usecases"
)

type StockCategoryHandler struct {
        stockCategoryUsecase usecases.StockCategoryUsecase
}

func NewStockCategoryHandler(uc usecases.StockCategoryUsecase) handlers.StockCategoryHandler <span class="cov0" title="0">{
        return &amp;StockCategoryHandler{
                stockCategoryUsecase: uc,
        }
}</span>

// GetAllCategories
// @Summary Categoryを全件取得
// @Tags Category
// @Produce json
// @Success 200 {array} entities.StockCategory
// @Failure 400
// @Failure 500
// @Router /categories [get]
func (h *StockCategoryHandler) GetAllCategories(c *gin.Context) *gin.Context <span class="cov0" title="0">{
        categories, err := h.stockCategoryUsecase.GetAllStockCategories()
        if err != nil </span><span class="cov0" title="0">{
                fmt.Println("GetAllStocks failed", err)
                c.JSON(http.StatusInternalServerError, gin.H{})
                return c
        }</span>
        <span class="cov0" title="0">c.JSON(http.StatusOK, &amp;handlers.Response[*entities.StockCategory]{
                Total:   len(categories),
                Results: categories,
                Errors:  nil,
        })
        return c</span>
}
</pre>
		
		<pre class="file" id="file7" style="display: none">package handlers

import (
        "fmt"
        "net/http"
        "strconv"

        "github.com/gin-gonic/gin"

        "github.com/go-ozzo/ozzo-validation/v4"
        _ "github.com/majikana-rinadehi/backend-manage-stock-go/docs"
        "github.com/majikana-rinadehi/backend-manage-stock-go/pkg/entities"
        "github.com/majikana-rinadehi/backend-manage-stock-go/pkg/interfaces/handlers"
        "github.com/majikana-rinadehi/backend-manage-stock-go/pkg/interfaces/usecases"
        "github.com/majikana-rinadehi/backend-manage-stock-go/util"
)

type StockHandler struct {
        stockUsecase usecases.StockUsecase
}

func NewStockHandler(uc usecases.StockUsecase) handlers.StockHandler <span class="cov0" title="0">{
        return &amp;StockHandler{
                stockUsecase: uc,
        }
}</span>

// GetAllStocks
// @Summary Stockを全件取得
// @Tags Stock
// @Produce json
// @Success 200 {array} entities.Stock
// @Failure 400
// @Failure 500
// @Router /stocks [get]
func (h *StockHandler) GetAllStocks(c *gin.Context) *gin.Context <span class="cov8" title="1">{
        stocks, err := h.stockUsecase.GetAllStocks()
        if err != nil </span><span class="cov8" title="1">{
                fmt.Println("GetAllStocks failed", err)
                c.JSON(http.StatusInternalServerError, &amp;handlers.Response[*entities.Stock]{
                        Total:   0,
                        Results: nil,
                        Errors: []*handlers.ErrorResponse{
                                {
                                        Message: "GetAllStocks failed",
                                },
                        },
                })
                return c
        }</span>
        <span class="cov8" title="1">c.JSON(http.StatusOK, &amp;handlers.Response[*entities.Stock]{
                Total:   len(stocks),
                Results: stocks,
                Errors:  nil,
        })
        return c</span>
}

// CreateStock
// @Summary Stockを1件登録
// @Tags Stock
// @Produce json
// @Param body body entities.Stock false "Stock"
// @Success 200 {object} entities.Stock "登録したStock"
// @Failure 400
// @Failure 500
// @Router /stocks [post]
func (h *StockHandler) CreateStock(c *gin.Context) *gin.Context <span class="cov8" title="1">{
        var newStock entities.Stock

        if bindErr := c.BindJSON(&amp;newStock); bindErr != nil </span><span class="cov0" title="0">{
                c.JSON(http.StatusBadRequest, &amp;handlers.Response[any]{
                        Total:   0,
                        Results: nil,
                        Errors: []*handlers.ErrorResponse{
                                {
                                        Message: bindErr.Error(),
                                },
                        },
                })
                return c
        }</span>

        // リクエストバリデーションチェック
        <span class="cov8" title="1">vErr := validateStock(newStock)

        if vErr != nil </span><span class="cov8" title="1">{
                handlers.BadRequests(c, vErr.(validation.Errors))
                return c
        }</span>

        <span class="cov8" title="1">stock, err := h.stockUsecase.CreateStock(&amp;newStock)

        if err != nil </span><span class="cov8" title="1">{
                c.JSON(http.StatusInternalServerError, &amp;handlers.Response[*entities.Stock]{
                        Total:   0,
                        Results: nil,
                        Errors: []*handlers.ErrorResponse{
                                {
                                        Message: "CreateStock failed",
                                },
                        },
                })
                return c
        }</span>

        <span class="cov8" title="1">c.JSON(http.StatusOK, &amp;handlers.Response[*entities.Stock]{
                Total: 1,
                Results: []*entities.Stock{
                        stock,
                },
                Errors: nil,
        })
        return c</span>
}

// DeleteStock
// @Summary idで指定したStockを1件削除する
// @Tags Stock
// @Produce json
// @Param id path string false "ID"
// @Success 204
// @Failure 400
// @Failure 500
// @Router /stocks/{id} [delete]
func (h *StockHandler) DeleteStock(c *gin.Context) *gin.Context <span class="cov8" title="1">{
        id, _ := strconv.Atoi(c.Param("id"))

        err := h.stockUsecase.DeleteStock(id)

        if err != nil </span><span class="cov8" title="1">{
                c.JSON(http.StatusInternalServerError, &amp;handlers.Response[any]{
                        Total:   0,
                        Results: nil,
                        Errors: []*handlers.ErrorResponse{
                                {
                                        Message: "DeleteStock failed",
                                },
                        },
                })
                return c
        }</span>

        <span class="cov8" title="1">c.Status(http.StatusNoContent)
        return c</span>
}

// UpdateStock
// @Summary idで指定したStockを1件更新する
// @Tags Stock
// @Produce json
// @Param id path string false "ID"
// @Param body body entities.Stock false "Stock"
// @Success 200
// @Failure 400
// @Failure 500
// @Router /stocks/{id} [put]
func (h *StockHandler) UpdateStock(c *gin.Context) *gin.Context <span class="cov0" title="0">{
        id, _ := strconv.Atoi(c.Param("id"))
        fmt.Println(id)

        var newStock entities.Stock

        if bindErr := c.BindJSON(&amp;newStock); bindErr != nil </span><span class="cov0" title="0">{
                c.JSON(http.StatusBadRequest, &amp;handlers.Response[any]{
                        Total:   0,
                        Results: nil,
                        Errors: []*handlers.ErrorResponse{
                                {
                                        Message: bindErr.Error(),
                                },
                        },
                })
                return c
        }</span>

        <span class="cov0" title="0">updatedStock, err := h.stockUsecase.UpdateStock(id, &amp;newStock)

        if err != nil </span><span class="cov0" title="0">{
                c.JSON(http.StatusInternalServerError, &amp;handlers.Response[any]{
                        Total:   0,
                        Results: nil,
                        Errors: []*handlers.ErrorResponse{
                                {
                                        Message: "UpdateStock failed",
                                },
                        },
                })
                return c
        }</span>

        <span class="cov0" title="0">c.JSON(http.StatusOK, &amp;handlers.Response[*entities.Stock]{
                Total: 1,
                Results: []*entities.Stock{
                        updatedStock,
                },
                Errors: nil,
        })
        return c</span>
}

// validateStock validates Stock data in request body
func validateStock(newStock entities.Stock) error <span class="cov8" title="1">{

        // リクエストバリデーションチェック
        vErr := validation.ValidateStruct(&amp;newStock,
                validation.Field(&amp;newStock.UserId,
                        validation.By(util.ValidateIntNotEmpty("userId")),
                ),
                validation.Field(&amp;newStock.CategoryId,
                        validation.By(util.ValidateIntNotEmpty("categoryId")),
                ),
                validation.Field(&amp;newStock.Name,
                        validation.By(util.ValidateStrNotEmpty("name")),
                        validation.Length(0, 255).Error(util.MaxLengthErrMsg("name", 255)),
                ),
                validation.Field(&amp;newStock.Amount,
                        validation.By(util.ValidateIntNotEmpty("amount")),
                ),
                validation.Field(&amp;newStock.ExpireDate,
                        validation.By(util.ValidateYYYY_MM_DD("expireDate")),
                ),
        )

        return vErr
}</span>
</pre>
		
		<pre class="file" id="file8" style="display: none">package handlers

import (
        "fmt"
        "net/http"

        "github.com/gin-gonic/gin"

        _ "github.com/majikana-rinadehi/backend-manage-stock-go/docs"
        "github.com/majikana-rinadehi/backend-manage-stock-go/pkg/interfaces/handlers"
        "github.com/majikana-rinadehi/backend-manage-stock-go/pkg/interfaces/usecases"
)

type UserHandler struct {
        stockUsecase usecases.UserUsecase
}

func NewUserHandler(uc usecases.UserUsecase) handlers.UserHandler <span class="cov0" title="0">{
        return &amp;UserHandler{
                stockUsecase: uc,
        }
}</span>

// GetAllUsers
// @Summary Userを全件取得
// @Tags User
// @Produce json
// @Success 200 {array} entities.User
// @Failure 400
// @Failure 500
// @Router /users [get]
func (h *UserHandler) GetAllUsers(c *gin.Context) *gin.Context <span class="cov0" title="0">{
        users, err := h.stockUsecase.GetAllUsers()
        if err != nil </span><span class="cov0" title="0">{
                fmt.Println("GetAllUsers failed", err)
                c.JSON(http.StatusInternalServerError, gin.H{})
                return c
        }</span>
        <span class="cov0" title="0">c.JSON(http.StatusOK, users)
        return c</span>
}
</pre>
		
		<pre class="file" id="file9" style="display: none">package adapters

import (
        "github.com/gin-gonic/gin"
        "github.com/majikana-rinadehi/backend-manage-stock-go/pkg/adapters/handlers"
        "github.com/majikana-rinadehi/backend-manage-stock-go/pkg/interfaces/usecases"
)

type HTTPAdapter struct {
        stockUc         usecases.StockUsecase
        stockCategoryUc usecases.StockCategoryUsecase
        userUc          usecases.UserUsecase
}

func NewHTTPAdapter(stockUc usecases.StockUsecase, stockCategoryUc usecases.StockCategoryUsecase, userUc usecases.UserUsecase) *HTTPAdapter <span class="cov0" title="0">{
        return &amp;HTTPAdapter{
                stockUc:         stockUc,
                stockCategoryUc: stockCategoryUc,
                userUc:          userUc,
        }
}</span>

func (a *HTTPAdapter) SetupRoutes(router *gin.Engine) <span class="cov0" title="0">{

        stockHandler := handlers.NewStockHandler(a.stockUc)
        stockCategoryHandler := handlers.NewStockCategoryHandler(a.stockCategoryUc)
        userHandler := handlers.NewUserHandler(a.userUc)

        // router.GET() の第二引数のシグネチャに合わせるため、ハンドラー関数をラップします。
        router.GET("/stocks", func(c *gin.Context) </span><span class="cov0" title="0">{
                stockHandler.GetAllStocks(c)
        }</span>)
        <span class="cov0" title="0">router.POST("/stocks", func(c *gin.Context) </span><span class="cov0" title="0">{
                stockHandler.CreateStock(c)
        }</span>)
        <span class="cov0" title="0">router.DELETE("/stocks/:id", func(c *gin.Context) </span><span class="cov0" title="0">{
                stockHandler.DeleteStock(c)
        }</span>)
        <span class="cov0" title="0">router.PUT("/stocks/:id", func(c *gin.Context) </span><span class="cov0" title="0">{
                stockHandler.UpdateStock(c)
        }</span>)
        <span class="cov0" title="0">router.GET("/categories", func(c *gin.Context) </span><span class="cov0" title="0">{
                stockCategoryHandler.GetAllCategories(c)
        }</span>)
        <span class="cov0" title="0">router.GET("/users", func(c *gin.Context) </span><span class="cov0" title="0">{
                userHandler.GetAllUsers(c)
        }</span>)
}
</pre>
		
		<pre class="file" id="file10" style="display: none">package entities

import (
        "github.com/majikana-rinadehi/backend-manage-stock-go/util"
)

type Stock struct {
        Id         int    `json:"id"`
        UserId     int    `json:"userId"`
        CategoryId int    `json:"categoryId"`
        Name       string `json:"name"`
        Amount     int    `json:"amount"`
        ExpireDate string `json:"expireDate"`
}

func (s Stock) String() string <span class="cov8" title="1">{
        return util.CustomStringer(s)
}</span>
</pre>
		
		<pre class="file" id="file11" style="display: none">package handlers

import (
        "net/http"

        "github.com/gin-gonic/gin"
        validation "github.com/go-ozzo/ozzo-validation/v4"
        "github.com/majikana-rinadehi/backend-manage-stock-go/util"
)

type ErrorResponse struct {
        Message string `json:"message"`
}

func (s ErrorResponse) String() string <span class="cov8" title="1">{
        return util.CustomStringer(s)
}</span>

func BadRequest(c *gin.Context, vErr validation.ErrorObject) <span class="cov0" title="0">{
        c.JSON(http.StatusBadRequest, &amp;Response[any]{
                Total:   0,
                Results: nil,
                Errors: []*ErrorResponse{
                        {
                                Message: vErr.Error(),
                        },
                },
        })
}</span>

func BadRequests(c *gin.Context, vErr validation.Errors) <span class="cov8" title="1">{
        errors := make([]*ErrorResponse, 0)
        for _, e := range vErr </span><span class="cov8" title="1">{
                errors = append(errors, &amp;ErrorResponse{
                        Message: e.Error(),
                })
        }</span>
        <span class="cov8" title="1">c.JSON(http.StatusBadRequest, &amp;Response[any]{
                Total:   0,
                Results: nil,
                Errors:  SortErrorResponse(errors),
        })</span>
}

func SortErrorResponse(errorList []*ErrorResponse) []*ErrorResponse <span class="cov8" title="1">{
        sorted := make([]*ErrorResponse, len(errorList))
        // 配列のディープコピー
        for i, err := range errorList </span><span class="cov8" title="1">{
                newErr := &amp;ErrorResponse{
                        Message: err.Message,
                }
                sorted[i] = newErr
        }</span>
        // sort.Slice, sort.SliceStableではうまく並び替えられなかった
        <span class="cov8" title="1">sortByMessage(sorted)
        return sorted</span>
}

// sortByMessageは、ErrorResponseの配列をMessageの辞書順(昇順)で並び替えます。
// バブルソートのアルゴリズムを使用しています。
func sortByMessage(list []*ErrorResponse) <span class="cov8" title="1">{
        length := len(list)
        if length &lt;= 1 </span><span class="cov0" title="0">{
                return
        }</span>

        <span class="cov8" title="1">for i := 0; i &lt; length-1; i++ </span><span class="cov8" title="1">{
                minIndex := i
                for j := i + 1; j &lt; length; j++ </span><span class="cov8" title="1">{
                        if list[j].Message &lt; list[minIndex].Message </span><span class="cov8" title="1">{
                                minIndex = j
                        }</span>
                }
                <span class="cov8" title="1">if minIndex != i </span><span class="cov8" title="1">{
                        list[i], list[minIndex] = list[minIndex], list[i]
                }</span>
        }
}
</pre>
		
		<pre class="file" id="file12" style="display: none">package handlers

import (
        "fmt"
        "reflect"
)

type Response[T any] struct {
        Total   int              `json:"total"`
        Results []T              `json:"results"`
        Errors  []*ErrorResponse `json:"errors"`
}

func (res Response[T]) String() string <span class="cov8" title="1">{
        output := "{\n"
        val := reflect.ValueOf(res)
        t := val.Type()

        for i := 0; i &lt; val.NumField(); i++ </span><span class="cov8" title="1">{
                field := val.Field(i)
                fieldValue := field.Interface()
                tagName := t.Field(i).Tag.Get("json")
                output += fmt.Sprintf("\t%s: %v,\n",
                        tagName, fieldValue)

        }</span>

        <span class="cov8" title="1">output += "}"
        return output</span>
}
</pre>
		
		<pre class="file" id="file13" style="display: none">package usecases

import (
        "fmt"

        "github.com/majikana-rinadehi/backend-manage-stock-go/pkg/entities"
        "github.com/majikana-rinadehi/backend-manage-stock-go/pkg/interfaces"
        "github.com/majikana-rinadehi/backend-manage-stock-go/pkg/interfaces/usecases"
)

type StockCategoryUsecase struct {
        r interfaces.StockCategoryRepository
}

func NewStockCategoryUsecase(r interfaces.StockCategoryRepository) usecases.StockCategoryUsecase <span class="cov0" title="0">{
        return &amp;StockCategoryUsecase{
                r: r,
        }
}</span>

func (uc StockCategoryUsecase) GetAllStockCategories() ([]*entities.StockCategory, error) <span class="cov0" title="0">{
        stocks, err := uc.r.FindAll()
        if err != nil </span><span class="cov0" title="0">{
                fmt.Println("Failed GetAllStockCategory; ", err)
                return nil, err
        }</span>
        <span class="cov0" title="0">return stocks, nil</span>
}
</pre>
		
		<pre class="file" id="file14" style="display: none">package usecases

import (
        "errors"
        "fmt"
        "strconv"

        "github.com/majikana-rinadehi/backend-manage-stock-go/pkg/entities"
        "github.com/majikana-rinadehi/backend-manage-stock-go/pkg/interfaces"
        "github.com/majikana-rinadehi/backend-manage-stock-go/pkg/interfaces/usecases"
)

type StockUsecase struct {
        r interfaces.StockRepository
}

func NewStockUsecase(r interfaces.StockRepository) usecases.StockUsecase <span class="cov0" title="0">{
        return &amp;StockUsecase{
                r: r,
        }
}</span>

func (uc StockUsecase) GetAllStocks() ([]*entities.Stock, error) <span class="cov0" title="0">{
        stocks, err := uc.r.FindAll()
        if err != nil </span><span class="cov0" title="0">{
                fmt.Println("Failed GetAllStock; ", err)
                return nil, err
        }</span>
        <span class="cov0" title="0">return stocks, nil</span>
}

func (uc StockUsecase) CreateStock(stock *entities.Stock) (*entities.Stock, error) <span class="cov0" title="0">{
        stockSaved, err := uc.r.Save(stock)
        if err != nil </span><span class="cov0" title="0">{
                fmt.Println("Failed CreateStock;", err)
                return nil, err
        }</span>
        <span class="cov0" title="0">return stockSaved, nil</span>
}

func (uc StockUsecase) DeleteStock(stockId int) error <span class="cov0" title="0">{
        err := uc.r.DeleteById(stockId)
        if err != nil </span><span class="cov0" title="0">{
                fmt.Println("Failed DeleteStock;", err)
                return err
        }</span>
        <span class="cov0" title="0">return nil</span>
}

func (uc StockUsecase) UpdateStock(id int, stock *entities.Stock) (*entities.Stock, error) <span class="cov0" title="0">{

        count, err := uc.r.CountById(id)
        if err != nil </span><span class="cov0" title="0">{
                fmt.Println("Failed UpdateStock;", err)
                return nil, err
        }</span>

        <span class="cov0" title="0">if count == 0 </span><span class="cov0" title="0">{
                fmt.Println("Update target not found;")
                return nil, errors.New("Not found: id = " + strconv.Itoa(id))
        }</span>

        <span class="cov0" title="0">stockUpdated, err := uc.r.Update(id, stock)
        if err != nil </span><span class="cov0" title="0">{
                fmt.Println("Failed UpdateStock;", err)
                return nil, err
        }</span>
        <span class="cov0" title="0">return stockUpdated, nil</span>
}
</pre>
		
		<pre class="file" id="file15" style="display: none">package usecases

import (
        "fmt"

        "github.com/majikana-rinadehi/backend-manage-stock-go/pkg/entities"
        "github.com/majikana-rinadehi/backend-manage-stock-go/pkg/interfaces"
        "github.com/majikana-rinadehi/backend-manage-stock-go/pkg/interfaces/usecases"
)

type UserUsecase struct {
        r interfaces.UserRepository
}

func NewUserUsecase(r interfaces.UserRepository) usecases.UserUsecase <span class="cov0" title="0">{
        return &amp;UserUsecase{
                r: r,
        }
}</span>

func (uc UserUsecase) GetAllUsers() ([]*entities.User, error) <span class="cov0" title="0">{
        stocks, err := uc.r.FindAll()
        if err != nil </span><span class="cov0" title="0">{
                fmt.Println("Failed GetAllUser; ", err)
                return nil, err
        }</span>
        <span class="cov0" title="0">return stocks, nil</span>
}
</pre>
		
		<pre class="file" id="file16" style="display: none">package util

import (
        "fmt"
        "reflect"
)

func CustomStringer(s interface{}) string <span class="cov8" title="1">{
        output := "\n\t\t{\n"
        val := reflect.ValueOf(s)
        t := val.Type()

        for i := 0; i &lt; val.NumField(); i++ </span><span class="cov8" title="1">{
                field := val.Field(i)
                fieldValue := field.Interface()
                tagName := t.Field(i).Tag.Get("json")
                output += fmt.Sprintf("\t\t\t%s: %v\n",
                        tagName, fieldValue)
        }</span>

        <span class="cov8" title="1">output += "\t\t},\n"

        return output</span>
}
</pre>
		
		<pre class="file" id="file17" style="display: none">package testutil

import (
        "fmt"
        "github.com/go-testfixtures/testfixtures/v3"
        "path"
        "runtime"

        "github.com/majikana-rinadehi/backend-manage-stock-go/pkg/adapters"
)

const (
        fixturesDirRelativePathFormat = "%s/../../internal/repositories/fixtures"
)

func SetupFixtures() <span class="cov8" title="1">{

        a := new(adapters.DatabaseAdapter)
        a.Connect(true)
        db, _ := a.GetDB()
        sqlDb, _ := db.DB()

        _, pwd, _, _ := runtime.Caller(0)
        dir := fmt.Sprintf(fixturesDirRelativePathFormat, path.Dir(pwd))

        fmt.Println("dir:", dir)

        fixtures, err := testfixtures.New(
                testfixtures.Database(sqlDb),  // You database connection
                testfixtures.Dialect("mysql"), // Available: "postgresql", "timescaledb", "mysql", "mariadb", "sqlite" and "sqlserver"
                testfixtures.Directory(dir),   // The directory containing the YAML files
        )
        if err != nil </span><span class="cov0" title="0">{
                panic(err)</span>
        }

        <span class="cov8" title="1">if err := fixtures.Load(); err != nil </span><span class="cov0" title="0">{
                panic(err)</span>
        }
}
</pre>
		
		<pre class="file" id="file18" style="display: none">package util

import (
        "fmt"
        "strings"
        "time"

        validation "github.com/go-ozzo/ozzo-validation/v4"
)

const (
        requiredErrMsgFormat    = "Param '%s' is required."
        invalidTypeErrMsgFormat = "Param '%s' must be a '%s'."
        maxLengthErrMsgFormat   = "Param '%s' length must be &lt;= '%d'."
)

func RequiredErrMsg(field string) string <span class="cov8" title="1">{
        return fmt.Sprintf(requiredErrMsgFormat, field)
}</span>

func InvalidTypeErrMsg(field, expectedType string) string <span class="cov8" title="1">{
        return fmt.Sprintf(invalidTypeErrMsgFormat, field, expectedType)
}</span>

func MaxLengthErrMsg(field string, maxLength int) string <span class="cov8" title="1">{
        return fmt.Sprintf(maxLengthErrMsgFormat, field, maxLength)
}</span>

func ValidateIntNotEmpty(fieldName string) validation.RuleFunc <span class="cov8" title="1">{
        return func(value interface{}) error </span><span class="cov8" title="1">{

                // 数値の場合
                v, okInt := value.(int)
                // FIXME: json上でのundefinedとzerovalueが現状区別できないから、0はリクエスト禁止www
                if !okInt || v == 0 </span><span class="cov8" title="1">{
                        return validation.NewError("Required", RequiredErrMsg(fieldName))
                }</span>

                <span class="cov8" title="1">return nil</span>
        }
}

func ValidateStrNotEmpty(fieldName string) validation.RuleFunc <span class="cov8" title="1">{
        return func(value interface{}) error </span><span class="cov8" title="1">{

                // string型の場合
                _, ok := value.(string)
                if !ok </span><span class="cov0" title="0">{
                        return validation.NewError("Required", RequiredErrMsg(fieldName))
                }</span>

                <span class="cov8" title="1">if strings.TrimSpace(value.(string)) == "" </span><span class="cov8" title="1">{
                        return validation.NewError("Required", RequiredErrMsg(fieldName))
                }</span>
                <span class="cov8" title="1">return nil</span>
        }
}

func ValidateYYYY_MM_DD(fieldName string) validation.RuleFunc <span class="cov8" title="1">{
        return func(value interface{}) error </span><span class="cov8" title="1">{

                dateStr, ok := value.(string)
                if !ok </span><span class="cov0" title="0">{
                        return validation.NewError("Required", RequiredErrMsg(fieldName))
                }</span>

                <span class="cov8" title="1">if strings.TrimSpace(dateStr) == "" </span><span class="cov8" title="1">{
                        return validation.NewError("Required", RequiredErrMsg(fieldName))
                }</span>

                // 日付の解析を試みる
                <span class="cov8" title="1">_, err := time.Parse("2006-01-02", dateStr)
                if err != nil </span><span class="cov8" title="1">{
                        return validation.NewError("InvalidDate", InvalidTypeErrMsg(fieldName, "YYYY-MM-DD"))
                }</span>

                <span class="cov8" title="1">return nil</span>
        }
}
</pre>
		
		</div>
	</body>
	<script>
	(function() {
		var files = document.getElementById('files');
		var visible;
		files.addEventListener('change', onChange, false);
		function select(part) {
			if (visible)
				visible.style.display = 'none';
			visible = document.getElementById(part);
			if (!visible)
				return;
			files.value = part;
			visible.style.display = 'block';
			location.hash = part;
		}
		function onChange() {
			select(files.value);
			window.scrollTo(0, 0);
		}
		if (location.hash != "") {
			select(location.hash.substr(1));
		}
		if (!visible) {
			select("file0");
		}
	})();
	</script>
</html>
